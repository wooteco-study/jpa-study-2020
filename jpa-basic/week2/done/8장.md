# 8장. 프록시와 연관관계 관리

## 8.1 프록시

엔티티의 값을 실제로 사용하는 시점에 DB에서 조회해오는 것을 지연로딩이라고 한다.
지연로딩을 하려면 실제 엔티티 객체 대신에 DB조회를 지연할 수 있는 가짜 객체를 프록시 객체라고 한다.
프록시 클래스는 실제 엔티티 클래스를 상속 받아서 만들어진다.
그래서 사용하는 입장에서는 진짜 엔티티 객체인지, 프록시 객체인지 구분하지 않고 사용하면 된다.
프록시 객체는 실제 객체에 대한 참조를 갖고 있다가 프록시 객체의 메서드를 호출하면 실제 객체의 메서드를 호출한다.
프록시 객체는 실제 사용될 때 DB를 조회해서 실제 엔티티 객체를 생성한다. (프록시 객체의 초기화)

```java
class Member extends Member {
    Member target = null;
		
    public String getName() {
        if (target == null) {
            // 초기화 요청
			// DB조회
			// 실제 엔티티 생성 및 참조 보관
        }
        
        return target.getName();
    }
}
```

특징

- 프록시 객체는 처음 사용할 때 한번만 초기화된다.
- 프록시 객체를 초기화하는 것이 프록시 객체를 실제 엔티티 객체로 바꾸는 것은 아니다. 프록시 객체가 초기화되면 프록시 객체가 갖고 있는 실제 엔티티 객체가 초기화된다.
- 프록시 객체는 원본 엔티티를 상속받은 객체이므로, 타입 체크 시에 주의해야 한다.
- 영속성 컨텍스트에 찾는 엔티티가 있으면 DB를 조회할 필요 없으므로 프록시 객체가 아니라 실제 엔티티 객체가 반환된다.
- 프록시 객체 초기화는 프록시 객체가 영속상태여야 가능하다. 준영속 상태의 프록시를 초기화하면 에러가 발생한다.
- 프록시 객체는 갖고있는 엔티티 객체의 pk를 보관하고 있어서 getId() 메서드를 호출해도 프록시 객체를 초기화 하지 않는다.

## 8.2 즉시 로딩과 지연 로딩

- 즉시로딩
    - 엔티티를 조회할 때, 연관된 엔티티도 함께 조회한다.
    - @ManyToOne(fetch = FetchType.EAGER)
    - 즉시로딩을 최적화하기 위해 가능하면 조인 쿼리를 사용한다.
    - 외래 키가 null 을 허용하면 outer join을 사용해서 쿼리를 날린다.
    - 외래 키 null 설정을 하면 inner join을 사용하도록 해서 성능 최적화를 할 수 있다.
    - @JoinColumn(name = "team_id", nullable = fasle)
    - @ManyToOne(fetch = FetchType.EAGER, optional = false)
- 지연로딩
    - 연관된 엔티티를 실제 사용할 때 조회한다.
    - @ManyToOne(fetch = FetchType.LAZY)
    - 조회 대상이 이미 영속성 컨텍스트에 있으면 프록시 객체가 아닌 실제 객체를 사용한다.